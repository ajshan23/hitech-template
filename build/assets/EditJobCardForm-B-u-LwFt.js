import{r as d,j as e,ai as E,a9 as J,ah as R}from"./index-DzuwMUJk.js";import{c as w,d as f,u as S,F as P,a as K}from"./formik.esm-CMit2tkc.js";import{c as M,a as n,e as k,f as I,b as T,g as $}from"./index.esm-DhwAFEkA.js";import{t as F,N as C}from"./toast-CcPug4ol.js";import{A as D}from"./AdaptableCard-BeBKmGTY.js";import{U as B}from"./useDidUpdate-DpKMmr0O.js";import"./Alert-vVBpJsa3.js";import"./index-DaxwILGT.js";import"./Badge-tWit_D0R.js";import{B as q}from"./Button-wjgR3boE.js";import"./index-DM5G7_gt.js";import"./Card-zb4SO3fb.js";import"./index-DwclNWPp.js";import"./index-CRCRnJq-.js";import"./Dialog-Cd76JUN6.js";import"./Drawer-DfVTzd_2.js";import"./index-ceQsHoYg.js";import"./useRootClose-CdIiGngw.js";import"./Input-Brks8ori.js";import"./index-DBljXpvd.js";import"./index-1pkQZEz6.js";import"./Skeleton-BvSpIA5c.js";import"./ScrollBar-BDcfAcYH.js";import"./index-DNk-pEkC.js";import"./Select-D4hXbUsF.js";import"./index-BAVH9xHy.js";import"./Tag-Bt59Vhpf.js";import{J as z,a as U}from"./JobCardMachineDetailsFields-Cu3CtECU.js";import"./context-DYzOV7Yr.js";import"./index-Blid5lza.js";import"./Views-B7C5aCBY.js";import"./get-CYTsGD9q.js";import"./toString-wyiJ7teT.js";import"./StatusIcon-f0e85OpL.js";import"./CloseButton-C9u0iwLZ.js";import"./chainedFunction-BxZSneMW.js";import"./_baseIsEqual-CuZKDLrf.js";import"./_getPrototype-BUYMZDCV.js";import"./index-BACBDbCl.js";import"./useColorLevel-10S34ZEH.js";import"./useControllableState-3FFwmPR4.js";import"./index-DyhAhzq0.js";import"./index-Chjiymov.js";import"./isNil-fn8XfVYM.js";import"./index-DEq-6zJ9.js";const V=g=>{const{values:u,setFieldValue:i}=g,[t,h]=d.useState([]),j=(l,a)=>{if(!l||l.length===0)return"Please upload an image file!";const r=l[0];return r.type.startsWith("image/")?r.size/1024<=500?!0:"Image size must be less than 500KB!":"Please upload an image file!"},N=l=>{const a=[...u.removedImages,l];i("removedImages",a);const r=u.images.filter(s=>s._id!==l);i("images",r)},m=l=>{const a=t.filter((r,s)=>s!==l);h(a),i("newImages",a)};return e.jsxs(D,{className:"mb-4",children:[e.jsx("h5",{children:"Job Card Images"}),e.jsx("p",{className:"mb-6",children:"Add or change images for the job card"}),e.jsx(w,{children:e.jsx(f,{name:"images",children:({field:l,form:a})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-4 mb-4",children:u.images.map(r=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:r.image,alt:"Job Card Image",className:"w-24 h-24 object-cover rounded-lg"}),e.jsx("button",{type:"button",className:"absolute top-0 right-0 bg-red-500 text-white rounded-full p-1",onClick:()=>N(r._id),children:"×"})]},r._id))}),e.jsx("div",{className:"flex flex-wrap gap-4 mb-4",children:t.map((r,s)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:URL.createObjectURL(r),alt:"New Job Card Image",className:"w-24 h-24 object-cover rounded-lg"}),e.jsx("button",{type:"button",className:"absolute top-0 right-0 bg-red-500 text-white rounded-full p-1",onClick:()=>m(s),children:"×"})]},s))}),e.jsx(B,{draggable:!0,beforeUpload:j,onChange:r=>{const s=Array.from(r);h(b=>[...b,...s]),i("newImages",[...t,...s])},children:e.jsxs("div",{className:"my-16 text-center",children:[e.jsxs("p",{className:"font-semibold",children:[e.jsxs("span",{className:"text-gray-800 dark:text-white",children:["Drop your image here, or"," "]}),e.jsx("span",{className:"text-blue-500",children:"browse"})]}),e.jsx("p",{className:"mt-1 opacity-60 dark:text-white",children:"Support: jpeg, png"})]})}),e.jsx("input",{type:"hidden",name:"removedImages",value:JSON.stringify(u.removedImages)})]})})})]})},_=g=>{var s,b,v,A;const{touched:u,errors:i}=g,{values:t,setFieldValue:h}=S();d.useEffect(()=>{t.attachments||h("attachments",[])},[t.attachments,h]);const j=d.useRef(null),N=d.useRef(null),m=d.useRef(null),l=d.useRef(null),a=(o,c)=>{if(o.key==="Enter"){if(o.shiftKey)return;if(o.preventDefault(),c){const p=document.querySelector(`[name="${c}"]`);p==null||p.focus()}}},r=o=>{o.current&&(o.current.style.height="auto",o.current.style.height=`${o.current.scrollHeight}px`)};return d.useEffect(()=>r(j),[t.works]),d.useEffect(()=>r(N),[t.spares]),d.useEffect(()=>r(m),[t.industrialworks]),d.useEffect(()=>r(l),[t.others]),e.jsxs(D,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Work Details"}),e.jsx("p",{className:"mb-6",children:"Section to configure work information"}),e.jsx(w,{label:"Works",invalid:!!i.works&&u.works,errorMessage:i.works,children:e.jsx(f,{as:"textarea",name:"works",placeholder:"Describe the works to be done",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:j,onKeyDown:o=>a(o,"spares"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(w,{label:"Spares",invalid:!!i.spares&&u.spares,errorMessage:i.spares,children:e.jsx(f,{as:"textarea",name:"spares",placeholder:"List the spares required",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:N,onKeyDown:o=>a(o,"industrialworks"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(w,{label:"Industrial Works",invalid:!!i.industrialworks&&u.industrialworks,errorMessage:i.industrialworks,children:e.jsx(f,{as:"textarea",name:"industrialworks",placeholder:"Describe any industrial works",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:m,onKeyDown:o=>a(o,"others"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(w,{label:"Others",invalid:!!i.others&&u.others,errorMessage:i.others,children:e.jsx(f,{as:"textarea",name:"others",placeholder:"Any other details",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:l,onKeyDown:o=>a(o),style:{overflow:"hidden",resize:"none"}})}),e.jsx(w,{label:"Select Additional Fittings",children:e.jsx("div",{className:"flex flex-col",children:e.jsxs("div",{className:"flex flex-row gap-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{type:"checkbox",id:"fan",name:"attachments",value:"fan",checked:(s=t.attachments)==null?void 0:s.includes("fan"),onChange:o=>{const{value:c,checked:p}=o.target,x=p?[...t.attachments||[],c]:(t.attachments||[]).filter(y=>y!==c);h("attachments",x)},className:"mr-2"}),e.jsx("label",{htmlFor:"fan",className:"text-gray-800 dark:text-white",children:"Fan"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{type:"checkbox",id:"fan_cover",name:"attachments",value:"fan cover",checked:(b=t.attachments)==null?void 0:b.includes("fan cover"),onChange:o=>{const{value:c,checked:p}=o.target,x=p?[...t.attachments||[],c]:(t.attachments||[]).filter(y=>y!==c);h("attachments",x)},className:"mr-2"}),e.jsx("label",{htmlFor:"fan_cover",className:"text-gray-800 dark:text-white",children:"Fan Cover"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{type:"checkbox",id:"terminal",name:"attachments",value:"terminal",checked:(v=t.attachments)==null?void 0:v.includes("terminal"),onChange:o=>{const{value:c,checked:p}=o.target,x=p?[...t.attachments||[],c]:(t.attachments||[]).filter(y=>y!==c);h("attachments",x)},className:"mr-2"}),e.jsx("label",{htmlFor:"terminal",className:"text-gray-800 dark:text-white",children:"Terminal"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(f,{type:"checkbox",id:"terminal_box",name:"attachments",value:"terminal box",checked:(A=t.attachments)==null?void 0:A.includes("terminal box"),onChange:o=>{const{value:c,checked:p}=o.target,x=p?[...t.attachments||[],c]:(t.attachments||[]).filter(y=>y!==c);h("attachments",x)},className:"mr-2"}),e.jsx("label",{htmlFor:"terminal_box",className:"text-gray-800 dark:text-white",children:"Terminal Box"})]})]})})})]})},L=M().shape({customerName:n().required("Customer Name is required"),customerAddress:n().required("Customer Address is required"),phoneNumber:n().required("Phone Number is required"),Make:n().nullable(),HP:k().nullable(),KVA:k().nullable(),RPM:k().nullable(),Type:n().nullable(),Frame:n().nullable(),SrNo:n().nullable(),DealerName:n().nullable(),DealerNumber:n().nullable(),works:n().nullable(),spares:n().nullable(),industrialworks:n().nullable(),attachments:I().of(n()),warranty:T(),others:n().nullable(),images:I().of($()),invoiceNumber:n().nullable(),removedImages:I().of(n())}),Te=()=>{const{id:g}=E(),u=J(),[i,t]=d.useState({customerName:"",customerAddress:"",phoneNumber:"",Make:"",HP:void 0,KVA:void 0,RPM:void 0,Type:"",Frame:"",SrNo:"",DealerName:"",DealerNumber:"",works:"",spares:"",industrialworks:"",attachments:[],warranty:!1,others:"",images:[],invoiceNumber:"",removedImages:[]}),[h,j]=d.useState(!1);d.useEffect(()=>{(async()=>{try{const a=(await R.get(`https://mytest.hitechengineeringcompany.in/api/jobcards/${g}`)).data.data;j(a.jobCardStatus==="Billed"),t({customerName:a.customerName,customerAddress:a.customerAddress,phoneNumber:a.phoneNumber,Make:a.Make,HP:a.HP,KVA:a.KVA,RPM:a.RPM,Type:a.Type,Frame:a.Frame,SrNo:a.SrNo,DealerName:a.DealerName,DealerNumber:a.DealerNumber,works:a.works,spares:a.spares,industrialworks:a.industrialworks,attachments:a.attachments||[],warranty:a.warranty,others:a.others,images:a.images||[],invoiceNumber:a.invoiceNumber,removedImages:[]})}catch(l){console.error("Error fetching job card:",l),F.push(e.jsx(C,{title:"Error",type:"danger",duration:2500,children:"Failed to fetch job card. Please try again."}),{placement:"top-center"})}})()},[g]);const N=async(m,{setSubmitting:l})=>{l(!0);const a=new FormData;Object.keys(m).forEach(r=>{const s=m[r];r==="attachments"&&Array.isArray(s)?s.forEach((b,v)=>{a.append(`attachments[${v}]`,b)}):r==="images"&&Array.isArray(s)?s.forEach(b=>{b instanceof File&&a.append("images",b)}):r==="removedImages"&&Array.isArray(s)?a.append(r,JSON.stringify(s)):s!=null&&a.append(r,s.toString())});try{if((await R.put(`https://mytest.hitechengineeringcompany.in/api/jobcards/${g}`,a,{headers:{"Content-Type":"multipart/form-data"}})).status!==200)throw new Error("Failed to update job card");F.push(e.jsx(C,{title:"Job Card Updated",type:"success",duration:2500,children:"Job card updated successfully."}),{placement:"top-center"}),u("/sales/jobcard-list")}catch(r){console.error("Error updating job card:",r),F.push(e.jsx(C,{title:"Error",type:"danger",duration:2500,children:"Failed to update job card. Please try again."}),{placement:"top-center"})}finally{l(!1)}};return e.jsx(P,{initialValues:i,validationSchema:L,onSubmit:N,enableReinitialize:!0,children:({values:m,touched:l,errors:a,isSubmitting:r,setFieldValue:s})=>e.jsxs(K,{children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx(z,{touched:l,errors:a}),e.jsx(U,{touched:l,errors:a,values:m}),e.jsx(_,{touched:l,errors:a}),h&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"invoiceNumber",className:"block text-sm font-medium text-gray-700",children:"Invoice Number"}),e.jsx(f,{type:"text",name:"invoiceNumber",placeholder:"Invoice Number",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400"})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(V,{values:{images:m.images,removedImages:m.removedImages},setFieldValue:s})})]}),e.jsx("div",{className:"mt-6",children:e.jsx(q,{variant:"solid",type:"submit",loading:r,disabled:r,children:r?"Updating...":"Update Job Card"})})]})})};export{Te as default};
