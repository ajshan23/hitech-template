import{j as e,r as h,aj as J,a7 as K,ah as M,ai as T}from"./index-D8EZYNHx.js";import{c as f,d as c,u as _,F as z,a as U}from"./formik.esm-2YDLR01m.js";import{c as W,a as d,e as N,f as w,b as H,g as S}from"./index.esm-B31dl2ce.js";import{t as F,N as C}from"./toast-C7jHvblq.js";import{A}from"./AdaptableCard-BEMK1SFf.js";import{U as L}from"./Upload-CTtO2M3U.js";import"./Alert-DbsNRRSF.js";import"./index-RMFzDg-A.js";import"./Badge-dzkq8wnb.js";import{B as V}from"./Button-BAgZyNTE.js";import"./index-356Hsfv7.js";import"./Card-D3euQ4_N.js";import"./index-BhP7YvoW.js";import"./index-CKbZ70H_.js";import"./Dialog-o_keClBI.js";import"./Drawer-Cdfikf9d.js";import"./index-B2aM9vQw.js";import"./useRootClose-CuhFRF3n.js";import{I as $}from"./Input-D5_BSRej.js";import"./index-BGivXdoS.js";import"./index-D6qi2naG.js";import"./Skeleton-lhhyWF6d.js";import"./ScrollBar-C2JZ1DMg.js";import"./index-BDZmxKtV.js";import"./Select-C6GQ0nNK.js";import"./index-wYfgWbp_.js";import"./Tag-D0COJtlv.js";import{F as O,a as q,b as G}from"./index-BVUIStRM.js";import{J as Q}from"./JobCardMachineDetailsFields-snsl2xNg.js";import"./context-HkwJrTD0.js";import"./index-CsNSl6Kk.js";import"./Views-CgaeU5aH.js";import"./get-DPkZYNvx.js";import"./toString-ayuhG4Ds.js";import"./StatusIcon-CnILfGF9.js";import"./CloseButton-C7TlJk6N.js";import"./chainedFunction-BxZSneMW.js";import"./_baseIsEqual-CjnU3fcr.js";import"./_getPrototype-pYDtWiyg.js";import"./index-BjDSyWEQ.js";import"./useColorLevel-10S34ZEH.js";import"./useControllableState-nlwpxWFS.js";import"./index-ByqCL_hN.js";import"./index-Chjiymov.js";import"./isNil-BluEIfBs.js";const X=p=>{const{values:m,setFieldValue:n}=p,o=s=>{if(!s||s.length===0)return"Please upload a file!";const t=s[0],r=t.type.startsWith("image/"),i=t.type==="application/pdf";return!r&&!i?"Please upload an image or PDF file!":t.size/1024/1024<=2?!0:"File size must be less than 2MB!"},g=s=>{n("newFiles",s)},u=s=>{if(!s||typeof s!="string"){console.error("Invalid file ID:",s);return}m.images.some(r=>r._id===s)&&n("removedImages",[...m.removedImages,s]);const t=m.images.filter(r=>r._id!==s);n("images",t)},x=s=>{const t=s.fileType==="application/pdf"||s.image.toLowerCase().endsWith(".pdf");return e.jsx("div",{className:"relative group",children:t?e.jsxs("div",{className:"flex items-center space-x-2 p-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg",children:[e.jsx(O,{className:"text-red-500 w-6 h-6"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("a",{href:s.image,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 truncate block",children:"View PDF"})}),e.jsx("button",{onClick:()=>u(s._id),className:"text-red-500 hover:text-red-700 p-1",title:"Remove file",children:e.jsx(q,{className:"w-4 h-4"})})]}):e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s.image,alt:"Preview",className:"w-24 h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-700"}),e.jsxs("div",{className:"absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center space-x-2 rounded-lg transition-opacity",children:[e.jsx("a",{href:s.image,target:"_blank",rel:"noopener noreferrer",className:"p-1 bg-white rounded-full hover:bg-gray-100",title:"View image",children:e.jsx(G,{className:"w-4 h-4 text-gray-700"})}),e.jsx("button",{onClick:()=>u(s._id),className:"p-1 bg-white rounded-full hover:bg-gray-100",title:"Remove image",children:e.jsx(q,{className:"w-4 h-4 text-red-500"})})]})]})})};return e.jsxs(A,{className:"mb-4",children:[e.jsx("h5",{children:"Job Card Files"}),e.jsx("p",{className:"mb-6",children:"Add or change files for the job card"}),e.jsx(f,{children:e.jsx(c,{name:"images",children:({field:s,form:t})=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 gap-4 mb-4",children:m.images.map(r=>e.jsx("div",{children:x(r)},r._id))}),e.jsx(L,{draggable:!0,beforeUpload:o,onChange:g,accept:".jpg,.jpeg,.png,.pdf",children:e.jsxs("div",{className:"my-16 text-center",children:[e.jsxs("p",{className:"font-semibold",children:[e.jsxs("span",{className:"text-gray-800 dark:text-white",children:["Drop your files here, or"," "]}),e.jsx("span",{className:"text-blue-500",children:"browse"})]}),e.jsx("p",{className:"mt-1 opacity-60 dark:text-white",children:"Support: jpeg, png, pdf (Max: 2MB)"})]})})]})})})]})},Y=p=>{var b,j,k,D,R,P,E,I;const{touched:m,errors:n}=p,{values:o,setFieldValue:g}=_();h.useEffect(()=>{o.attachments||g("attachments",[])},[o.attachments,g]);const u=h.useRef(null),x=h.useRef(null),s=h.useRef(null),t=h.useRef(null),r=(a,v)=>{if(a.key==="Enter"){if(a.shiftKey)return;if(a.preventDefault(),v){const y=document.querySelector(`[name="${v}"]`);y==null||y.focus()}}},i=a=>{a.current&&(a.current.style.height="auto",a.current.style.height=`${a.current.scrollHeight}px`)};h.useEffect(()=>i(u),[o.works]),h.useEffect(()=>i(x),[o.spares]),h.useEffect(()=>i(s),[o.industrialworks]),h.useEffect(()=>i(t),[o.others]);const l=(a,v)=>{const y=v?[...o.attachments||[],a]:(o.attachments||[]).filter(B=>B!==a);g("attachments",y)};return e.jsxs(A,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Work Details"}),e.jsx("p",{className:"mb-6",children:"Section to configure work information"}),e.jsx(f,{label:"Works",invalid:!!n.works&&m.works,errorMessage:n.works,children:e.jsx(c,{as:"textarea",name:"works",placeholder:"Describe the works to be done",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:u,onKeyDown:a=>r(a,"spares"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(f,{label:"Spares",invalid:!!n.spares&&m.spares,errorMessage:n.spares,children:e.jsx(c,{as:"textarea",name:"spares",placeholder:"List the spares required",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:x,onKeyDown:a=>r(a,"industrialworks"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(f,{label:"Industrial Works",invalid:!!n.industrialworks&&m.industrialworks,errorMessage:n.industrialworks,children:e.jsx(c,{as:"textarea",name:"industrialworks",placeholder:"Describe any industrial works",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:s,onKeyDown:a=>r(a,"others"),style:{overflow:"hidden",resize:"none"}})}),e.jsx(f,{label:"Others",invalid:!!n.others&&m.others,errorMessage:n.others,children:e.jsx(c,{as:"textarea",name:"others",placeholder:"Any other details",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:t,onKeyDown:a=>r(a),style:{overflow:"hidden",resize:"none"}})}),e.jsx(f,{label:"Select Additional Fittings",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"fan",name:"attachments",value:"fan",checked:(b=o.attachments)==null?void 0:b.includes("fan"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"fan",className:"text-gray-800 dark:text-white",children:"Fan"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"fan_cover",name:"attachments",value:"fan cover",checked:(j=o.attachments)==null?void 0:j.includes("fan cover"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"fan_cover",className:"text-gray-800 dark:text-white",children:"Fan Cover"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"terminal",name:"attachments",value:"terminal",checked:(k=o.attachments)==null?void 0:k.includes("terminal"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"terminal",className:"text-gray-800 dark:text-white",children:"Terminal"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"terminal_box",name:"attachments",value:"terminal box",checked:(D=o.attachments)==null?void 0:D.includes("terminal box"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"terminal_box",className:"text-gray-800 dark:text-white",children:"Terminal Box"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"pulli",name:"attachments",value:"pulli",checked:(R=o.attachments)==null?void 0:R.includes("pulli"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"pulli",className:"text-gray-800 dark:text-white",children:"Pulli"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"avr",name:"attachments",value:"AVR",checked:(P=o.attachments)==null?void 0:P.includes("AVR"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"avr",className:"text-gray-800 dark:text-white",children:"AVR"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"diode",name:"attachments",value:"diode",checked:(E=o.attachments)==null?void 0:E.includes("diode"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"diode",className:"text-gray-800 dark:text-white",children:"Diode"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(c,{type:"checkbox",id:"grill",name:"attachments",value:"grill",checked:(I=o.attachments)==null?void 0:I.includes("grill"),onChange:a=>{l(a.target.value,a.target.checked)},className:"mr-2"}),e.jsx("label",{htmlFor:"grill",className:"text-gray-800 dark:text-white",children:"Grill"})]})]})})]})},Z=p=>{const{touched:m,errors:n,values:o,setFieldValue:g}=p,u=h.useRef(null),x=o.phoneNumber||[],s=(t,r)=>{if(t.key==="Enter"){t.preventDefault();{const i=document.querySelector(`[name="${r}"]`);i==null||i.focus()}}};return h.useEffect(()=>{u.current&&(u.current.style.height="auto",u.current.style.height=`${u.current.scrollHeight}px`)},[o.customerAddress]),e.jsxs(A,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Customer Details"}),e.jsx("p",{className:"mb-6",children:"Section to configure customer information"}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mb-6",children:"Fields marked with * are required"}),e.jsx(f,{label:"Customer Name *",invalid:!!n.customerName&&m.customerName,errorMessage:n.customerName,children:e.jsx(c,{type:"text",autoComplete:"off",name:"customerName",placeholder:"Customer Name",component:$,onKeyDown:t=>s(t,"customerAddress")})}),e.jsx(f,{label:"Customer Address *",invalid:!!n.customerAddress&&m.customerAddress,errorMessage:n.customerAddress,children:e.jsx(c,{as:"textarea",name:"customerAddress",placeholder:"Customer Address",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400",rows:1,innerRef:u,style:{overflow:"hidden",resize:"none"}})}),e.jsxs(f,{label:"Phone Numbers *",invalid:!!n.phoneNumber&&m.phoneNumber,children:[x.map((t,r)=>e.jsx(c,{type:"tel",autoComplete:"tel",name:`phoneNumber[${r}]`,placeholder:`Phone Number ${r+1}`,component:$,className:"mb-2"},r)),e.jsx(V,{size:"sm",type:"button",onClick:()=>g("phoneNumber",[...x,""]),children:"Add Phone Number"})]})]})},ee=W().shape({customerName:d().required("Customer Name is required"),customerAddress:d().required("Customer Address is required"),phoneNumber:N().of(d().required("Phone Number is required")).min(1,"At least one phone number is required"),Make:d().nullable(),HP:w().nullable(),KVA:w().nullable(),RPM:w().nullable(),Type:d().nullable(),Frame:d().nullable(),SrNo:d().nullable(),DealerName:d().nullable(),DealerNumber:d().nullable(),works:d().nullable(),spares:d().nullable(),industrialworks:d().nullable(),attachments:N().of(d()),warranty:H(),others:d().nullable(),images:N().of(S()),invoiceNumber:d().nullable(),removedImages:N().of(d()),newFiles:N().of(S())}),He=()=>{const{id:p}=J(),m=K(),[n,o]=h.useState({customerName:"",customerAddress:"",phoneNumber:[""],Make:"",HP:void 0,KVA:void 0,RPM:void 0,Type:"",Frame:"",SrNo:"",DealerName:"",DealerNumber:"",works:"",spares:"",industrialworks:"",attachments:[],warranty:!1,others:"",images:[],invoiceNumber:"",removedImages:[],newFiles:[]}),[g,u]=h.useState(!1);h.useEffect(()=>{p&&(async()=>{try{const r=(await M.get(`${T}/jobcards/${p}`)).data.data;u(r.jobCardStatus==="Billed"),o({customerName:r.customerName,customerAddress:r.customerAddress,phoneNumber:r.phoneNumber||[""],Make:r.Make,HP:r.HP,KVA:r.KVA,RPM:r.RPM,Type:r.Type,Frame:r.Frame,SrNo:r.SrNo,DealerName:r.DealerName,DealerNumber:r.DealerNumber,works:r.works,spares:r.spares,industrialworks:r.industrialworks,attachments:r.attachments||[],warranty:r.warranty,others:r.others,images:r.images.map(i=>({...i,fileType:i.fileType||(i.image.toLowerCase().endsWith(".pdf")?"application/pdf":"image/jpeg")}))||[],invoiceNumber:r.invoiceNumber,removedImages:[],newFiles:[]})}catch(t){console.error("Error fetching job card:",t),F.push(e.jsx(C,{title:"Error",type:"danger",duration:2500,children:"Failed to fetch job card. Please try again."}),{placement:"top-center"})}})()},[p]);const x=async(s,{setSubmitting:t})=>{t(!0);const r=new FormData;s.removedImages&&s.removedImages.length>0&&r.append("removedImages",JSON.stringify(s.removedImages)),s.newFiles&&s.newFiles.length>0&&s.newFiles.forEach(l=>{r.append("files",l)});const i=["newFiles","removedImages","images"];Object.keys(s).filter(l=>!i.includes(l)).forEach(l=>{const b=s[l];Array.isArray(b)?b.forEach((j,k)=>{r.append(`${l}[${k}]`,j)}):b!=null&&r.append(l,b.toString())});try{const l=await M.put(`${T}/jobcards/${p}`,r,{headers:{"Content-Type":"multipart/form-data"}});F.push(e.jsx(C,{title:"Success",type:"success",duration:2500,children:"Job card updated successfully"}),{placement:"top-center"}),m(-1)}catch(l){console.error("Error updating job card:",l),F.push(e.jsx(C,{title:"Error",type:"danger",duration:2500,children:"Failed to update job card. Please try again."}),{placement:"top-center"})}finally{t(!1)}};return e.jsx(z,{initialValues:n,validationSchema:ee,onSubmit:x,enableReinitialize:!0,children:({values:s,touched:t,errors:r,isSubmitting:i,setFieldValue:l})=>((r.customerName||r.customerAddress||r.phoneNumber)&&Object.keys(t).length>0&&window.scrollTo({top:0,behavior:"smooth"}),e.jsxs(U,{children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx(Z,{touched:t,errors:r,values:s,setFieldValue:l}),e.jsx(Q,{touched:t,errors:r,values:s}),e.jsx(Y,{touched:t,errors:r}),g&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"invoiceNumber",className:"block text-sm font-medium text-gray-700",children:"Invoice Number"}),e.jsx(c,{type:"text",name:"invoiceNumber",placeholder:"Invoice Number",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 dark:bg-[#1f2937] dark:border-gray-600 dark:text-white dark:placeholder-gray-400"})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(X,{values:{images:s.images,removedImages:s.removedImages},setFieldValue:l})})]}),e.jsx("div",{className:"mt-6",children:e.jsx(V,{variant:"solid",type:"submit",loading:i,disabled:i,children:i?"Updating...":"Update Job Card"})})]}))})};export{He as default};
